---
title: "Corona-virus exploratory data analysis"
author: "Luis Chaves"
date: "`r format(Sys.time(), '%d %B, %Y')`"
runtime: shiny
output: 
  html_document:
    toc: TRUE
    toc_float: TRUE
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r, warning = F, message = F}
library(ggplot2)
library(plotly)
library(tidyverse)
library(utils)
library(lubridate)
library(htmlwidgets)
library(crosstalk)
library(highcharter)
library(shiny)
library(Cairo)
curr.dir = paste0(here::here(), "/EDA/")
# print(curr.dir)
# knitr::opts_knit$set(root.dir = curr.dir)
```

```{r}
getwd()
list.files(".")
list.files("./ProcessedData/")
```

# Introduction

Hello and thanks for visiting my page on COVID19 exploratory data analysis. I have made this site as a learning exercise but also to better understand the current state of the pandemic at multiple levels.

There are many more plots and perspective I would like to exploit and that I am currently working on:

* Bubble map over time and by exact location
* Graph of the reproduction number (R0) over time
* Graphs of the global statistics
* Log10 switch for the amounts of people tested positive, dead or recovered
* Give context and explanations to the graphics

If you have any other suggestions please get in touch at [luis.chaves15@imperial.ac.uk](mailto:luis.chaves15@imperial.ac.uk).

Data sources:

* [Corona Virus dataset @ Kaggle](https://www.kaggle.com/sudalairajkumar/novel-corona-virus-2019-dataset)

Some amazing resources:

* [John Hopkins University dashboard](https://coronavirus.jhu.edu/map.html)
* [SARS-COV2 phylogenetic tree](https://nextstrain.org/ncov)
* [COVID19 scenario explorer](https://neherlab.org/covid19/)

# Up-to-date numbers by continent and by country

## Table view
```{r}
selectInput("table", label = "By",
              choices = c("Continent", "Country","Full"), selected = "Country")
```

```{r warning = F, message = F}
sum.table = readRDS("ProcessedData/sumtable.rds")
continent.wise =  readRDS("ProcessedData/continentWise.rds")
```

```{r}
renderTable(
  switch(input$table,
         "Country"=sum.table %>% head(20),
         "Continent"=continent.wise,
         "Full"=sum.table)
)
```

## Up-to-date number of events by location

```{r}
deads = readRDS("ProcessedData/treemapDeaths.rds")
rec = readRDS("ProcessedData/treemapRecovered.rds")
conf = readRDS("ProcessedData/treemapConfirmed.rds")
deaths.conf = readRDS("ProcessedData/treemapDeaths2Confirmed.rds")
rec.conf = readRDS("ProcessedData/treemapRecovered2Confirmed.rds")
```


```{r}
selectInput("t.choice", label = "Event/Metric",
              choices = c("Deaths(D)", "Recovered(R)","Confirmed(C)",
                          "D/C ratio", "R/C ratio"), selected = "Deaths(D)")
```

```{r}
ItalyDC = round(with(sum.table[sum.table$Country.Region == "Italy",], Deaths/Confirmed),4)*100
GermanyDC = round(with(sum.table[sum.table$Country.Region == "Germany",], Deaths/Confirmed),4)*100
```

```{r}
renderText(
  if (input$t.choice=="D/C ratio"){
    paste0("In this graph we can clearly see how the virus (and potentially different strains of the virus) are affecting every country. As of today, Italy has a case-fatality rate (CFR) of ", as.character(ItalyDC), "% where as Germany has a CFR of ", as.character(GermanyDC), "% suggesting the strain in Germany is way less deadly than the italian strain.")
  }
)
```


```{r}
renderPlotly(
  if (input$t.choice == "Deaths(D)"){
  deads
} else if (input$t.choice == "Confirmed(C)") {
  conf
} else if (input$t.choice == "Recovered(R)") {
  rec
} else if (input$t.choice == "D/C ratio") {
  deaths.conf
} else if (input$t.choice == "R/C ratio") {
  rec.conf
}
)
```

```{r}

fooOutput <- function(outputId, width = "100%", height = "400px") {
  htmlwidgets::shinyWidgetOutput("./ProcessedData/treemapConfirmed.html", "foo", width, height)
}
fig = shinyRenderWidget("ProcessedData/treemapConfirmed.html",fooOutput, quoted = T, env = parent.frame())
fig
```



# COVID19 over time - Timelines

```{r}
all.time = readRDS("ProcessedData/cleanTime.rds")
```

```{r}
plt.deaths.time = readRDS("ProcessedData/DeathsOverTime.rds")
plt.conf.time = readRDS("ProcessedData/ConfOverTime.rds")
plt.rec.time = readRDS("ProcessedData/RecoveredOverTime.rds")
plt.act.time = readRDS("ProcessedData/ActiveOverTime.rds")
```

## Cumulative number of events over time

```{r}
selectInput("plt.time.choice", label = "Event/Metric",
              choices = c("Deaths(D)", "Recovered(R)",
                          "Confirmed(C)", "Active(A)"), selected = 20)
```

```{r}
renderPlotly(
  if (input$plt.time.choice == "Deaths(D)"){
  plt.deaths.time
} else if (input$plt.time.choice == "Confirmed(C)") {
  plt.conf.time
} else if (input$plt.time.choice == "Recovered(R)") {
  plt.rec.time
}  else if (input$plt.time.choice == "Active(A)") {
  plt.act.time
}
  )
```

## Number of events per day over time
```{r}
d.daytime = readRDS("ProcessedData/deathsPerDay.rds")
conf.daytime = readRDS("ProcessedData/confPerDay.rds")
rec.daytime = readRDS("ProcessedData/recPerDay.rds")
```

The value for any day is the difference of the cumulative cases/deaths/recoveries for that day day and the day before then.

```{r}
selectInput("plt.day.choice", label = "Event/Metric",
              choices = c("Deaths(D)", "Recovered(R)",
                          "Confirmed(C)", "Active(A)"), selected = 20)
```


```{r}
renderPlotly(
  if (input$plt.day.choice == "Deaths(D)"){
  d.daytime
} else if (input$plt.day.choice == "Confirmed(C)") {
  conf.daytime
} else if (input$plt.day.choice == "Recovered(R)") {
  rec.daytime
}
  )
```

## Barplots over time

Over time from `r format(min(all.time$Date),"%B %dnd")` to  `r format(max(all.time$Date),"%B %dnd")`

```{r}
bar.over.time = readRDS("ProcessedData/StackedOverTime.rds")
byevent = readRDS("ProcessedData/BarFacet.rds")
```

```{r message = F}
selectInput("barplot", label = "Type of barplot",
            choices = c("Stacked bars", "By event"), selected = "Stacked bars")

renderPlotly(
  switch(input$barplot,
         "Stacked bars" = bar.over.time,
         "By event" = byevent)
)
```

## Race plots

### Confirmed cases
![](ProcessedData/confirmed.gif)

### Deaths
![](ProcessedData/deaths.gif)

### Recovered
![](ProcessedData/recovered.gif)


# COVID19 over space - Maps


```{r}
# could have 2 maps, one by iso code the other by actual location (long,lat)
country.iso = read.csv("https://gist.githubusercontent.com/tadast/8827699/raw/7255fdfbf292c592b75cf5f7a19c16ea59735f74/countries_codes_and_coordinates.csv")
country.iso$Alpha.3.code = trimws(country.iso$Alpha.3.code)
all.time = all.time %>% 
  mutate(Country = ifelse(Country=="Iran", "Iran, Islamic Republic of",
                          ifelse(Country =="Korea, South","South Korea",
                                 ifelse(Country=="Laos","Lao People's Democratic Republic",
                                        ifelse(Country=="Moldova", "Moldova, Republic of",
                                               ifelse(Country == "Syria","Syrian Arab Republic",
                                                      ifelse(Country=="Tanzania","Tanzania, United Republic of",
                                                             ifelse(Country=="US","United States", Country)
                                                             )
                                                      )
                                        )
                                 )
                          )
  )
  )

all.time.geo = merge(all.time, country.iso[,c("Country","Alpha.3.code")], by = "Country", all.x = T)

all.time.geo = all.time.geo %>% select(-Continent) %>%
  pivot_wider(names_from = "Metric", values_from = "Amount") %>%
  mutate(Date=as.numeric(Date-min(Date)))
```


```{r}
StartDate = min(all.time$Date)

l <- list(color = toRGB("grey"), width = 0.5)

g <- list(
  showframe = T,
  showcoastlines = FALSE,
  projection = list(type = 'natural earth')
)

all.time.geo %>%
  plot_geo() %>% add_trace(z = ~Confirmed, color = ~Confirmed, frame = ~Date, colors = 'Blues',
              text = ~Country, locations = ~Alpha.3.code, marker = list(line = l)) %>% 
  colorbar(title = 'Confirmed') %>%
  layout(
    title = 'Number of confirmed cases over time',
    geo = g
  ) %>% animation_opts(redraw = F) %>%
  animation_slider(
    currentvalue = list(
      prefix = paste0("Days from ",
                      format(StartDate, "%B %dnd"),": ")))
```


